<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Learning + Surprise Reflection Worksheet</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body {
  font-family: system-ui, sans-serif;
  background:#111;
  color:#eee;
  padding:20px;
}

#exportBar {
  display:flex;
  gap:10px;
  margin-bottom:20px;
  padding-bottom:10px;
  border-bottom:1px solid #333;
  flex-wrap:wrap;
}

.question {
  border:1px solid #333;
  border-radius:10px;
  padding:15px;
  margin-bottom:18px;
  background:#181818;
}

textarea {
  width:100%;
  min-height:60px;
  background:#000;
  color:#fff;
  border:1px solid #333;
  border-radius:6px;
  padding:8px;
  font-size:14px;
}

.responses {
  margin-top:8px;
  font-size:0.8rem;
  color:#aaa;
}

button {
  padding:6px 12px;
  border-radius:6px;
  border:none;
  cursor:pointer;
}

.admin-btn {
  background:#c00;
  color:#fff;
}
</style>
</head>

<body>

<div id="exportBar">
  <button onclick="exportMyPDF()">Export My Answers (Student PDF)</button>
  <button onclick="exportTeacherPDF()">Export Teacher View</button>
  <button onclick="exportPNG()">Export Full Page (PNG)</button>
  <button onclick="exportCSV()">Export My Answers (CSV)</button>
  <button class="admin-btn" onclick="adminReset()">Admin Reset</button>
</div>

<h1>Learning + Surprise Reflection Worksheet</h1>
<div id="anonLabel"></div>
<div id="questions"></div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore,
  collection,
  addDoc,
  query,
  where,
  onSnapshot,
  getDocs,
  deleteDoc,
  doc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* Firebase Config */
const firebaseConfig = {
  apiKey: "AIzaSyDKIdi4HrzXvL-1nBk_Ct1gTIViDRnhSxk",
  authDomain: "art104-presentation3.firebaseapp.com",
  projectId: "art104-presentation3",
  storageBucket: "art104-presentation3.firebasestorage.app",
  messagingSenderId: "163602255735",
  appId: "1:163602255735:web:a4344f4dc757231b825b72"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* Anonymous ID */
function generateID() {
  return Math.random().toString(36).substring(2, 8).toUpperCase();
}

let anonID = localStorage.getItem("anonID");
if (!anonID) {
  anonID = generateID();
  localStorage.setItem("anonID", anonID);
}

document.getElementById("anonLabel").textContent =
  `Your anonymous ID: ${anonID}`;

/* Build Questions */
const container = document.getElementById("questions");

for (let i = 1; i <= 24; i++) {
  const div = document.createElement("div");
  div.className = "question";
  div.innerHTML = `
    <h3>Presentation ${i}</h3>
    <p>
      Write one sentence about either:
      <br><br>
      <strong>1)</strong> Something new that you learned
      <br>
      <strong>OR</strong>
      <br>
      <strong>2)</strong> Something that surprised you.
    </p>
    <textarea id="text-${i}" placeholder="Write one sentence..."></textarea><br>
    <button onclick="submitAnswer(${i})">Submit</button>
    <div class="responses" id="responses-${i}"></div>
  `;
  container.appendChild(div);
  listenForResponses(i);
}

/* Submit */
window.submitAnswer = async function(num) {
  const text = document.getElementById(`text-${num}`).value.trim();
  if (!text) return alert("Please write something first.");

  await addDoc(collection(db, "responses"), {
    questionNumber: num,
    text,
    anonID,
    timestamp: Date.now()
  });

  document.getElementById(`text-${num}`).value = "";
};

/* Live Responses */
function listenForResponses(num) {
  const q = query(
    collection(db, "responses"),
    where("questionNumber", "==", num)
  );

  onSnapshot(q, (snapshot) => {
    const box = document.getElementById(`responses-${num}`);
    box.innerHTML = "";

    snapshot.forEach((docSnap) => {
      const d = docSnap.data();
      const row = document.createElement("div");
      row.textContent = `${d.anonID}: ${d.text}`;
      box.appendChild(row);
    });
  });
}

/* Fetch My Responses */
async function getMyResponses() {
  const q = query(
    collection(db, "responses"),
    where("anonID", "==", anonID)
  );
  const snapshot = await getDocs(q);
  return snapshot.docs.map(d => d.data());
}

/* Engineering Frame */
function addEngineeringFrame(pdf, pageNumber, titleText) {
  const pageWidth = pdf.internal.pageSize.getWidth();
  const pageHeight = pdf.internal.pageSize.getHeight();

  pdf.setLineWidth(0.8);
  pdf.rect(10, 10, pageWidth - 20, pageHeight - 20);
  pdf.setLineWidth(0.5);
  pdf.rect(10, pageHeight - 30, pageWidth - 20, 20);

  pdf.setFontSize(8);
  pdf.setFont("helvetica", "normal");
  pdf.text(titleText, 15, pageHeight - 20);
  pdf.text(`Date: ${new Date().toLocaleDateString()}`, 15, pageHeight - 15);
  pdf.text(`Page ${pageNumber}`, pageWidth - 30, pageHeight - 15);
}

/* Student PDF */
window.exportMyPDF = async function () {

  const responses = await getMyResponses();
  if (!responses.length) return alert("No responses found.");

  responses.sort((a, b) => a.questionNumber - b.questionNumber);

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("p", "mm", "a4");

  const pageHeight = pdf.internal.pageSize.getHeight();
  const marginTop = 30;
  const marginBottom = 30;
  const lineHeight = 6;

  const headingSize = 16;  // Larger
  const answerSize = 12;   // Consistent answer size

  let y = marginTop;
  let pageNumber = 1;

  addEngineeringFrame(pdf, pageNumber, `Student Copy — ID: ${anonID}`);

  for (let r of responses) {

    const wrapped = pdf.splitTextToSize(r.text, 170);
    const blockHeight = wrapped.length * lineHeight + 18;

    if (y + blockHeight > pageHeight - marginBottom) {
      pdf.addPage();
      pageNumber++;
      addEngineeringFrame(pdf, pageNumber, `Student Copy — ID: ${anonID}`);
      y = marginTop;
    }

    // HEADING
    pdf.setFont("helvetica", "bold");
    pdf.setFontSize(headingSize);
    pdf.text(`Presentation ${r.questionNumber}`, 20, y);
    y += 10;

    // ANSWER
    pdf.setFont("helvetica", "normal");
    pdf.setFontSize(answerSize);
    pdf.text(wrapped, 20, y);
    y += wrapped.length * lineHeight + 12;
  }

  pdf.save(`student_${anonID}.pdf`);
};

</script>
</body>
</html>
